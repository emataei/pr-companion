const fs = require('fs');
const { createOrUpdateComment, getPRNumber } = require('./pr-comment-utils');

/**
 * Check if dependency analysis provides meaningful information
 * @param {string} baseFile - Path to the dependency analysis file
 * @returns {boolean} True if dependency analysis should be shown
 */
function isDependencyAnalysisUseful(baseFile) {
  if (!fs.existsSync(baseFile)) {
    return false;
  }
  
  try {
    const content = fs.readFileSync(baseFile, 'utf8');
    
    // Skip if content is too short (likely just boilerplate)
    if (content.length < 100) {
      return false;
    }
    
    // Skip if it contains common "no changes" indicators
    const noChangeIndicators = [
      'no significant changes',
      'no dependency changes',
      'dependency analysis not available',
      'no new dependencies',
      'analysis failed'
    ];
    
    const lowercaseContent = content.toLowerCase();
    if (noChangeIndicators.some(indicator => lowercaseContent.includes(indicator))) {
      return false;
    }
    
    // Show if it contains meaningful dependency information
    const meaningfulIndicators = [
      'new dependency',
      'removed dependency', 
      'version change',
      'security impact',
      'breaking change',
      'major version'
    ];
    
    return meaningfulIndicators.some(indicator => lowercaseContent.includes(indicator));
  } catch (error) {
    console.log(`Error checking dependency analysis: ${error.message}`);
    return false;
  }
}

async function postSeparateVisualComments({ github, context }) {
  const prNumber = getPRNumber(context);
  if (!prNumber) {
    console.log('No PR number found, skipping visual comments');
    return;
  }

  const visuals = [
    {
      name: 'PR Impact Grid',
      description: 'Shows risk score, review time estimate, file change heatmap, and development intent',
      baseFile: '.code-analysis/outputs/development_flow_embed.md',
      identifier: 'pr-impact-grid'
    },
    {
      name: 'PR Dependencies',
      description: 'Key dependency changes and impact analysis (shown only when significant)',
      baseFile: '.code-analysis/outputs/dependency_graph_pr_embed.md',
      identifier: 'pr-dependencies'
    }
  ];

  for (const visual of visuals) {
    try {
      // Skip dependency analysis if it's not meaningful
      if (visual.identifier === 'pr-dependencies' && !isDependencyAnalysisUseful(visual.baseFile)) {
        console.log(`Skipping ${visual.name} - no significant dependency changes detected`);
        continue;
      }
      
      let content = '';
      
      // Try to read the embed file with base64 image
      if (fs.existsSync(visual.baseFile)) {
        const embedContent = fs.readFileSync(visual.baseFile, 'utf8');
        
        // Check if content is too large (GitHub limit is ~65KB)
        if (embedContent.length > 60000) {
          console.log(`${visual.name} embed too large (${embedContent.length} chars), using placeholder`);
          content = `## ${visual.name}

${visual.description}

Image not displayed due to size limits. Available in [workflow artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`;
        } else {
          content = `## ${visual.name}

${visual.description}

${embedContent}`;
        }
      } else {
        // Skip posting comment if file doesn't exist (especially for dependencies)
        if (visual.identifier === 'pr-dependencies') {
          console.log(`Skipping ${visual.name} - analysis file not generated`);
          continue;
        }
        
        // Fallback if embed file doesn't exist for other visuals
        content = `## ${visual.name}

${visual.description}

Image not generated. Check workflow logs for details.`;
      }

      // Add footer
      content += `

*Generated by PR Visuals workflow*`;

      // Post or update the comment for this specific visual
      await createOrUpdateComment(
        github,
        context,
        prNumber,
        content,
        `pr-visual-${visual.identifier}`
      );

      console.log(`âœ… Posted/updated ${visual.name} comment`);
      
      // Small delay to avoid rate limiting
      await new Promise(resolve => setTimeout(resolve, 500));
      
    } catch (error) {
      console.error(`Failed to post ${visual.name} comment:`, error.message);
    }
  }
}

module.exports = postSeparateVisualComments;
